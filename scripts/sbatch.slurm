#!/bin/bash
#
# Based on scripts generated by Nemo.
#

# Parameters
#SBATCH --account=team_mle
#SBATCH --exclusive
#SBATCH --mem=0
#SBATCH --partition=a4
#SBATCH --time=0

set -evx

LOG_PREFIX=${LOG_DIR}/${SLURM_JOB_NAME}_${SLURM_JOB_ID}_$(date +"%Y%m%d_%H%M%S")
mkdir -p ${LOG_PREFIX}

exec > "$LOG_PREFIX/sbatch.out" 2>&1

echo "Starting job: $SLURM_JOB_NAME"
echo "SLURM Job ID: $SLURM_JOB_ID"

export PYTHONUNBUFFERED=1
export SLURM_UNBUFFEREDIO=1
export TORCHX_MAX_RETRIES=0

set +e
export LD_LIBRARY_PATH=/usr/local/gib/lib64:$LD_LIBRARY_PATH

# setup

nodes=( $( scontrol show hostnames $SLURM_JOB_NODELIST ) )
nodes_array=($nodes)
head_node=${nodes_array[0]}
head_node_ip=$(srun --nodes=1 --ntasks=1 -w "$head_node" hostname --ip-address)

export CUDA_DEVICE_MAX_CONNECTIONS=1
export NCCL_IB_TC=52
export NCCL_IB_FIFO_TC=84
export NCCL_NVLS_CHUNKSIZE=524288
export NCCL_SOCKET_IFNAME=enp0s19,enp192s20
export NCCL_NET_GDR_LEVEL=PIX
export NCCL_NET=gIB
export NCCL_IB_GID_INDEX=3
export NCCL_P2P_NET_CHUNKSIZE=131072
export NCCL_IB_QPS_PER_CONNECTION=4
export NCCL_P2P_PCI_CHUNKSIZE=131072
export NCCL_P2P_NVL_CHUNKSIZE=524288
export NCCL_TUNER_CONFIG_PATH=/usr/local/gib/configs/tuner_config_a4.txtpb
export NCCL_IB_ADAPTIVE_ROUTING=1
export NCCL_CROSS_NIC=0
export MASTER_ADDR=$head_node_ip
export MASTER_PORT=29501
export TORCHRUN_TRAINER_SCRIPT=${WORK_DIR}/${TRAIN_SCRIPT}
export NCCL_DEBUG=WARN
# Command 1

srun \
  --output $LOG_PREFIX/node_%t_${SLURM_RESTART_COUNT:-0}.out \
  --container-image /home/common/images/vmds-nemo-20250721.sqsh \
  --container-mounts /usr/local/gib,$WORK_DIR,/home/sihanzeng_meta_com/miniconda3,/mnt/lustre/metavmds0lstre/data/engage_seq/engage_seq_v4_hstu \
  --container-workdir $WORK_DIR \
  --kill-on-bad-exit=1 \
  --container-writable \
  --no-container-mount-home \
  --mpi=pmix \
  bash -c "source /home/sihanzeng_meta_com/miniconda3/bin/activate hstu && $WORK_DIR/scripts/torchrun.cmd"

exitcode=$?

set -e

echo "job exited with code $exitcode"
if [ $exitcode -ne 0 ]; then
    if [ "$TORCHX_MAX_RETRIES" -gt "${SLURM_RESTART_COUNT:-0}" ]; then
        scontrol requeue "$SLURM_JOB_ID"
    fi
    exit $exitcode
